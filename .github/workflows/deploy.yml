name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Lark notification - Deployment Started
        uses: echoings/actions.notify@v0.1.0
        with:
          plat_type: "Lark"
          notify_title: "üöÄ Deployment Frontend Started"
          notify_message: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Commit Message: ${{ github.event.head_commit.message }}
            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.workflow }}
        env:
          NOTIFY_WEBHOOK: ${{ secrets.LARK_WEBHOOK_URL }}
          NOTIFY_SIGNKEY: ${{ secrets.LARK_SIGNKEY }}
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}

      - name: Deploy to DigitalOcean Server
        id: deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            echo "üöÄ Starting deployment..."

            # Set variables (adjust these paths as needed)
            PROJECT_PATH="${{ secrets.USERNAME }}/edvara-fe"
            REPO_URL="https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"

            echo "REPO_URL: $REPO_URL"
            echo "PROJECT_PATH: $PROJECT_PATH"

            # Create project directory if it doesn't exist
            mkdir -p "$(dirname "$PROJECT_PATH")"

            # Check if project directory exists and has git repository

            echo "üìÇ Project exists, pulling latest changes..."
            cd "$PROJECT_PATH"

            # Pull latest changes
            git pull

            # Check if Node.js and npm are available
            if ! command -v node &> /dev/null; then
              echo "‚ùå Node.js is not installed. Please install Node.js first."
              exit 1
            fi

            echo "üîç Checking project directory..."
            ls -la

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production=false

            # Build the project
            echo "üî® Building project..."
            npm run build

            # Check if build was successful
            if [ -d "dist" ]; then
              echo "‚úÖ Build completed successfully!"
              echo "üìÅ Build files are in: $PROJECT_PATH/dist"
            else
              echo "‚ùå Build failed - no dist directory found"
              exit 1
            fi

            # Optional: Copy build files to web server directory
            # Uncomment and adjust path as needed for your web server setup
            # echo "üöÄ Copying files to web server..."
            # sudo cp -r dist/* /var/www/html/
            # sudo chown -R www-data:www-data /var/www/html/

            # Optional: Restart web server if needed
            # echo "üîÑ Restarting web server..."
            # sudo systemctl restart nginx

            echo "‚úÖ Deployment completed successfully!"

      - name: Send Lark notification - Deployment Success
        if: success()
        uses: echoings/actions.notify@v0.1.0
        with:
          plat_type: "Lark"
          notify_title: "‚úÖ Deployment Frontend Completed Successfully"
          notify_message: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Commit Message: ${{ github.event.head_commit.message }}
            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.workflow }}

            üéâ Your application has been deployed!
        env:
          NOTIFY_WEBHOOK: ${{ secrets.LARK_WEBHOOK_URL }}
          NOTIFY_SIGNKEY: ${{ secrets.LARK_SIGNKEY }}
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}

      - name: Send Lark notification - Deployment Failed
        if: failure()
        uses: echoings/actions.notify@v0.1.0
        with:
          plat_type: "Lark"
          notify_title: "‚ùå Deployment Frontend Failed"
          notify_message: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Commit Message: ${{ github.event.head_commit.message }}
            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.workflow }}

            ‚ö†Ô∏è Please check the workflow logs for details.
        env:
          NOTIFY_WEBHOOK: ${{ secrets.LARK_WEBHOOK_URL }}
          NOTIFY_SIGNKEY: ${{ secrets.LARK_SIGNKEY }}
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
